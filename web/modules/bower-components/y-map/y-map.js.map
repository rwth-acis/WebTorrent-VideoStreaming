{"version":3,"sources":["../yjs/node_modules/browser-pack/_prelude.js","src/Map.js","y-map.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length",1,"module","_classCallCheck","instance","Constructor","TypeError","extend","Y","YMap","os","model","contents","opContents","_this","this","_model","id","map","utils","copyObject","eventHandler","EventHandler","op","oldValue","key","struct","parentSub","prevType","Promise","resolve","requestTransaction","regeneratorRuntime","mark","_callee","type","wrap","_context","prev","next","delegateYield","getType","t0","stop","left","value","opContent","_callee2","_context2","deleted","content","undefined","callEventListeners","name","object","compareIds","target","_createClass","destroy","_this2","oid","_callee3","_context3","Object","keys","concat","_this3","_callee4","_context4","reject","right","del","modDel","_callee5","_context5","awaitOps","applyCreatedOperations","awaitAndPrematurelyCall","_this4","insert","getNextOpId","origin","parent","typeDefinition","isTypeDefinition","typeid","_callee6","_context6","createType","_callee7","_context7","addEventListener","removeEventListener","path","observeProperty","event","propertyName","property","self","get","then","observe","unobserve","deleteChildObservers","resetObserverPath","promise","set","Map","observePath","slice","_deleteChildObservers","observer","_changed","transaction","_context8","getOperation","receivedOp","CustomType","class","initType","YMapInitializer","_context9","t1","done","t2","abrupt","defineProperties","props","descriptor","enumerable","configurable","writable","defineProperty","protoProps","staticProps","prototype"],"mappings":"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","file":"y-map.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/* global Y */\n'use strict'\n\nfunction extend (Y /* :any */) {\n  class YMap {\n    /* ::\n    _model: Id;\n    os: Y.AbstractDatabase;\n    map: Object;\n    contents: any;\n    opContents: Object;\n    eventHandler: Function;\n    */\n    constructor (os, model, contents, opContents) {\n      this._model = model.id\n      this.os = os\n      this.map = Y.utils.copyObject(model.map)\n      this.contents = contents\n      this.opContents = opContents\n      this.eventHandler = new Y.utils.EventHandler(op => {\n        var oldValue\n        // key is the name to use to access (op)content\n        var key = op.struct === 'Delete' ? op.key : op.parentSub\n\n        // compute oldValue\n        if (this.opContents[key] != null) {\n          let prevType = this.opContents[key]\n          oldValue = () => {// eslint-disable-line\n            return new Promise((resolve) => {\n              this.os.requestTransaction(function *() {// eslint-disable-line\n                var type = yield* this.getType(prevType)\n                resolve(type)\n              })\n            })\n          }\n        } else {\n          oldValue = this.contents[key]\n        }\n        // compute op event\n        if (op.struct === 'Insert') {\n          if (op.left === null) {\n            var value\n            // TODO: what if op.deleted??? I partially handles this case here.. but need to send delete event instead. somehow related to #4\n            if (op.opContent != null) {\n              value = () => {// eslint-disable-line\n                return new Promise((resolve) => {\n                  this.os.requestTransaction(function *() {// eslint-disable-line\n                    var type = yield* this.getType(op.opContent)\n                    resolve(type)\n                  })\n                })\n              }\n              delete this.contents[key]\n              if (op.deleted) {\n                delete this.opContents[key]\n              } else {\n                this.opContents[key] = op.opContent\n              }\n            } else {\n              value = op.content[0]\n              delete this.opContents[key]\n              if (op.deleted) {\n                delete this.contents[key]\n              } else {\n                this.contents[key] = op.content[0]\n              }\n            }\n            this.map[key] = op.id\n            if (oldValue === undefined) {\n              this.eventHandler.callEventListeners({\n                name: key,\n                object: this,\n                type: 'add',\n                value: value\n              })\n            } else {\n              this.eventHandler.callEventListeners({\n                name: key,\n                object: this,\n                oldValue: oldValue,\n                type: 'update',\n                value: value\n              })\n            }\n          }\n        } else if (op.struct === 'Delete') {\n          if (Y.utils.compareIds(this.map[key], op.target)) {\n            delete this.opContents[key]\n            delete this.contents[key]\n            this.eventHandler.callEventListeners({\n              name: key,\n              object: this,\n              oldValue: oldValue,\n              type: 'delete'\n            })\n          }\n        } else {\n          throw new Error('Unexpected Operation!')\n        }\n      })\n    }\n    _destroy () {\n      this.eventHandler.destroy()\n      this.eventHandler = null\n      this.contents = null\n      this.opContents = null\n      this._model = null\n      this.os = null\n      this.map = null\n    }\n    get (key) {\n      // return property.\n      // if property does not exist, return null\n      // if property is a type, return a promise\n      if (key == null || typeof key !== 'string') {\n        throw new Error('You must specify a key (as string)!')\n      }\n      if (this.opContents[key] == null) {\n        return this.contents[key]\n      } else {\n        return new Promise((resolve) => {\n          var oid = this.opContents[key]\n          this.os.requestTransaction(function *() {\n            var type = yield* this.getType(oid)\n            resolve(type)\n          })\n        })\n      }\n    }\n    keys () {\n      return Object.keys(this.contents).concat(Object.keys(this.opContents))\n    }\n    keysPrimitives () {\n      return Object.keys(this.contents)\n    }\n    keysTypes () {\n      return Object.keys(this.opContents)\n    }\n    /*\n      If there is a primitive (not a custom type), then return it.\n      Returns all primitive values, if propertyName is specified!\n      Note: modifying the return value could result in inconsistencies!\n        -- so make sure to copy it first!\n    */\n    getPrimitive (key) {\n      if (key == null) {\n        return Y.utils.copyObject(this.contents)\n      } else if (typeof key !== 'string') {\n        throw new Error('Key is expected to be a string!')\n      } else {\n        return this.contents[key]\n      }\n    }\n    getType (key) {\n      if (key == null || typeof key !== 'string') {\n        throw new Error('You must specify a key (as string)!')\n      } else if (this.opContents[key] != null) {\n        return new Promise((resolve) => {\n          var oid = this.opContents[key]\n          this.os.requestTransaction(function *() {\n            var type = yield* this.getType(oid)\n            resolve(type)\n          })\n        })\n      } else {\n        return Promise.reject('No property specified for this key!')\n      }\n    }\n    delete (key) {\n      var right = this.map[key]\n      if (right != null) {\n        var del = {\n          target: right,\n          struct: 'Delete'\n        }\n        var eventHandler = this.eventHandler\n        var modDel = Y.utils.copyObject(del)\n        modDel.key = key\n        this.os.requestTransaction(function *() {\n          yield* eventHandler.awaitOps(this, this.applyCreatedOperations, [[del]])\n        })\n        // always remember to do that after this.os.requestTransaction\n        // (otherwise values might contain a undefined reference to type)\n        eventHandler.awaitAndPrematurelyCall([modDel])\n      }\n    }\n    set (key, value) {\n      // set property.\n      // if property is a type, return a promise\n      // if not, apply immediately on this type an call event\n\n      var right = this.map[key] || null\n      var insert /* :any */ = {\n        id: this.os.getNextOpId(1),\n        left: null,\n        right: right,\n        origin: null,\n        parent: this._model,\n        parentSub: key,\n        struct: 'Insert'\n      }\n      var eventHandler = this.eventHandler\n      return new Promise((resolve) => {\n        var typeDefinition = Y.utils.isTypeDefinition(value)\n        if (typeDefinition !== false) {\n          var typeid = this.os.getNextOpId(1)\n          insert.opContent = typeid\n          // construct a new type\n          this.os.requestTransaction(function *() {\n            var type = yield* this.createType(typeDefinition, typeid)\n            yield* eventHandler.awaitOps(this, this.applyCreatedOperations, [[insert]])\n            resolve(type)\n          })\n          // always remember to do that after this.os.requestTransaction\n          // (otherwise values might contain a undefined reference to type)\n          eventHandler.awaitAndPrematurelyCall([insert])\n        } else {\n          insert.content = [value]\n          this.os.requestTransaction(function * () {\n            yield* eventHandler.awaitOps(this, this.applyCreatedOperations, [[insert]])\n          })\n          // always remember to do that after this.os.requestTransaction\n          // (otherwise values might contain a undefined reference to type)\n          eventHandler.awaitAndPrematurelyCall([insert])\n          resolve(value)\n        }\n      })\n    }\n    observe (f) {\n      this.eventHandler.addEventListener(f)\n    }\n    unobserve (f) {\n      this.eventHandler.removeEventListener(f)\n    }\n    /*\n      Observe a path.\n\n      E.g.\n      ```\n      o.set('textarea', Y.TextBind)\n      o.observePath(['textarea'], function(t){\n        // is called whenever textarea is replaced\n        t.bind(textarea)\n      })\n\n      returns a Promise that contains a function that removes the observer from the path.\n    */\n    observePath (path, f) {\n      var self = this\n      function observeProperty (event) {\n        // call f whenever path changes\n        if (event.name === propertyName) {\n          // call this also for delete events!\n          var property = self.get(propertyName)\n          if (property instanceof Promise) {\n            property.then(f)\n          } else {\n            f(property)\n          }\n        }\n      }\n\n      if (path.length < 1) {\n        f(this)\n        return Promise.resolve(function () {})\n      } else if (path.length === 1) {\n        var propertyName = path[0]\n        var property = self.get(propertyName)\n        if (property instanceof Promise) {\n          property.then(f)\n        } else {\n          f(property)\n        }\n        this.observe(observeProperty)\n        return Promise.resolve(function () {\n          self.unobserve(f)\n        })\n      } else {\n        var deleteChildObservers\n        var resetObserverPath = function () {\n          var promise = self.get(path[0])\n          if (!promise instanceof Promise) {\n            // its either not defined or a primitive value\n            promise = self.set(path[0], Y.Map)\n          }\n          return promise.then(function (map) {\n            return map.observePath(path.slice(1), f)\n          }).then(function (_deleteChildObservers) {\n            // update deleteChildObservers\n            deleteChildObservers = _deleteChildObservers\n            return Promise.resolve() // Promise does not return anything\n          })\n        }\n        var observer = function (event) {\n          if (event.name === path[0]) {\n            if (deleteChildObservers != null) {\n              deleteChildObservers()\n            }\n            if (event.type === 'add' || event.type === 'update') {\n              resetObserverPath()\n            }\n            // TODO: what about the delete events?\n          }\n        }\n        self.observe(observer)\n        return resetObserverPath().then(function () {\n          // this promise contains a function that deletes all the child observers\n          // and how to unobserve the observe from this object\n          return Promise.resolve(function () { // eslint-disable-line\n            if (deleteChildObservers != null) {\n              deleteChildObservers()\n            }\n            self.unobserve(observer)\n          })\n        })\n      }\n    }\n    * _changed (transaction, op) {\n      if (op.struct === 'Delete') {\n        var target = yield* transaction.getOperation(op.target)\n        op.key = target.parentSub\n      }\n      this.eventHandler.receivedOp(op)\n    }\n  }\n  Y.extend('Map', new Y.utils.CustomType({\n    name: 'Map',\n    class: YMap,\n    struct: 'Map',\n    initType: function * YMapInitializer (os, model) {\n      var contents = {}\n      var opContents = {}\n      var map = model.map\n      for (var name in map) {\n        var op = yield* this.getOperation(map[name])\n        if (op.deleted) continue\n        if (op.opContent != null) {\n          opContents[name] = op.opContent\n        } else {\n          contents[name] = op.content[0]\n        }\n      }\n      return new YMap(os, model, contents, opContents)\n    }\n  }))\n}\n\nmodule.exports = extend\nif (typeof Y !== 'undefined') {\n  extend(Y)\n}\n",null],"sourceRoot":"/source/"}